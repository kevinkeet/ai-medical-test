<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical AI Competency Assessment</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 1.5rem;
            color: var(--gray-900);
        }

        .header-info {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .timer {
            font-size: 1.25rem;
            font-weight: 600;
            padding: 8px 16px;
            background: var(--gray-100);
            border-radius: 8px;
            font-variant-numeric: tabular-nums;
        }

        .timer.warning { background: #fef3c7; color: var(--warning); }
        .timer.danger { background: #fee2e2; color: var(--danger); }

        .progress-bar {
            width: 200px;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        /* Registration */
        .registration {
            background: white;
            padding: 40px;
            border-radius: 12px;
            max-width: 500px;
            margin: 60px auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .registration h2 {
            margin-bottom: 10px;
            color: var(--gray-900);
        }

        .registration p {
            color: var(--gray-600);
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .panel-header h3 {
            font-size: 1rem;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-content {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            max-height: 500px;
        }

        /* Section Navigation */
        .section-nav {
            display: flex;
            gap: 8px;
            padding: 15px 20px;
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }

        .section-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            background: var(--gray-100);
            color: var(--gray-600);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .section-btn:hover { background: var(--gray-200); }
        .section-btn.active { background: var(--primary); color: white; }
        .section-btn.completed { background: var(--success); color: white; }

        .section-btn .status-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid currentColor;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .section-btn.completed .status-icon::after {
            content: '‚úì';
        }

        /* Case Content */
        .case-content {
            font-size: 0.95rem;
        }

        .case-content h4 {
            color: var(--primary);
            margin: 16px 0 8px 0;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .case-content h4:first-child {
            margin-top: 0;
        }

        .case-content p {
            margin-bottom: 12px;
        }

        .case-content ul, .case-content ol {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .case-content li {
            margin-bottom: 4px;
        }

        .vitals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 12px 0;
        }

        .vital-item {
            background: var(--gray-50);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .vital-label {
            font-size: 0.75rem;
            color: var(--gray-600);
            text-transform: uppercase;
        }

        .vital-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .vital-value.abnormal {
            color: var(--danger);
        }

        .lab-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            margin: 12px 0;
        }

        .lab-table th, .lab-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .lab-table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
        }

        .lab-table .abnormal {
            color: var(--danger);
            font-weight: 600;
        }

        /* Chat Interface */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.9rem;
        }

        .message.user {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant {
            align-self: flex-start;
            background: var(--gray-100);
            color: var(--gray-800);
            border-bottom-left-radius: 4px;
        }

        .message.system {
            align-self: center;
            background: #fef3c7;
            color: var(--warning);
            font-size: 0.85rem;
            padding: 8px 12px;
        }

        .message pre {
            background: rgba(0,0,0,0.1);
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 8px 0;
            font-size: 0.85rem;
        }

        .chat-input-area {
            padding: 15px;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 0.95rem;
            resize: none;
            min-height: 50px;
            max-height: 120px;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .send-btn {
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        .send-btn:hover { background: var(--primary-dark); }
        .send-btn:disabled { background: var(--gray-300); cursor: not-allowed; }

        /* Response Area */
        .response-area {
            margin-top: 20px;
        }

        .response-area label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .response-textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 0.95rem;
            resize: vertical;
            font-family: inherit;
        }

        .response-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover { background: var(--primary-dark); }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover { background: var(--gray-300); }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover { background: #047857; }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        /* Task Instructions */
        .task-instructions {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .task-instructions h4 {
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .task-instructions p {
            color: var(--gray-700);
            font-size: 0.9rem;
        }

        /* Medication Alert */
        .medication-list {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
        }

        .medication-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .medication-item:last-child {
            border-bottom: none;
        }

        .med-name {
            font-weight: 500;
        }

        .med-dose {
            color: var(--gray-600);
        }

        /* Results Page */
        .results-page {
            background: white;
            padding: 40px;
            border-radius: 12px;
            max-width: 900px;
            margin: 40px auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .results-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--gray-200);
        }

        .results-header h2 {
            color: var(--gray-900);
            margin-bottom: 10px;
        }

        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            text-align: center;
            padding: 20px;
            background: var(--gray-50);
            border-radius: 8px;
        }

        .summary-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .summary-card .label {
            font-size: 0.85rem;
            color: var(--gray-600);
            margin-top: 5px;
        }

        .section-result {
            margin-bottom: 25px;
            padding: 20px;
            background: var(--gray-50);
            border-radius: 8px;
        }

        .section-result h4 {
            color: var(--gray-800);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-result .response-display {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--gray-200);
            white-space: pre-wrap;
            font-size: 0.9rem;
        }

        .hidden { display: none !important; }

        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-300);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Print styles */
        @media print {
            body { background: white; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>
    <!-- Registration Page -->
    <div id="registration-page" class="container">
        <div class="registration">
            <h2>Medical AI Competency Assessment</h2>
            <p>This assessment evaluates your ability to effectively use AI tools in clinical practice. The test takes approximately 30 minutes and covers diagnostic reasoning, treatment planning, error detection, summarization, and patient communication.</p>

            <form id="registration-form">
                <div class="form-group">
                    <label for="participant-name">Full Name</label>
                    <input type="text" id="participant-name" required placeholder="Dr. Jane Smith">
                </div>
                <div class="form-group">
                    <label for="participant-email">Email</label>
                    <input type="email" id="participant-email" required placeholder="jane.smith@hospital.org">
                </div>
                <div class="form-group">
                    <label for="participant-role">Role</label>
                    <select id="participant-role" required>
                        <option value="">Select your role</option>
                        <option value="Attending Physician">Attending Physician</option>
                        <option value="Resident">Resident</option>
                        <option value="Fellow">Fellow</option>
                        <option value="Medical Student">Medical Student</option>
                        <option value="Nurse Practitioner">Nurse Practitioner</option>
                        <option value="Physician Assistant">Physician Assistant</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="participant-specialty">Specialty</label>
                    <input type="text" id="participant-specialty" required placeholder="Internal Medicine">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">
                    Begin Assessment
                </button>
            </form>
        </div>
    </div>

    <!-- Main Assessment Page -->
    <div id="assessment-page" class="container hidden">
        <div class="header">
            <h1>Medical AI Competency Assessment</h1>
            <div class="header-info">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <div class="timer" id="timer">30:00</div>
            </div>
        </div>

        <div class="section-nav" id="section-nav">
            <button class="section-btn active" data-section="0">
                <span class="status-icon"></span>
                1. Diagnosis
            </button>
            <button class="section-btn" data-section="1">
                <span class="status-icon"></span>
                2. Management
            </button>
            <button class="section-btn" data-section="2">
                <span class="status-icon"></span>
                3. Error Detection
            </button>
            <button class="section-btn" data-section="3">
                <span class="status-icon"></span>
                4. Summarization
            </button>
            <button class="section-btn" data-section="4">
                <span class="status-icon"></span>
                5. Patient Instructions
            </button>
        </div>

        <div class="main-layout">
            <!-- Case Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h3>üìã Clinical Case</h3>
                </div>
                <div class="panel-content">
                    <div id="case-content"></div>
                </div>
            </div>

            <!-- AI Chat Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h3>ü§ñ AI Assistant</h3>
                </div>
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        <div class="message system">
                            Use the AI assistant to help with this task. Your interaction will be recorded for review.
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <textarea
                            class="chat-input"
                            id="chat-input"
                            placeholder="Ask the AI assistant..."
                            rows="2"
                        ></textarea>
                        <button class="send-btn" id="send-btn">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Response Area -->
        <div class="panel" style="margin-top: 20px;">
            <div class="panel-header">
                <h3>‚úçÔ∏è Your Response</h3>
            </div>
            <div class="panel-content">
                <div class="task-instructions" id="task-instructions"></div>
                <div class="response-area">
                    <label for="user-response">Enter your final answer below:</label>
                    <textarea
                        class="response-textarea"
                        id="user-response"
                        placeholder="Type your response here..."
                    ></textarea>
                </div>
                <div class="button-group">
                    <button class="btn btn-secondary" id="prev-btn">‚Üê Previous</button>
                    <button class="btn btn-primary" id="save-btn">Save & Continue ‚Üí</button>
                    <button class="btn btn-success hidden" id="finish-btn">Finish Assessment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Page -->
    <div id="results-page" class="container hidden">
        <div class="results-page">
            <div class="results-header">
                <h2>Assessment Complete</h2>
                <p id="results-participant-info"></p>
            </div>

            <div class="results-summary">
                <div class="summary-card">
                    <div class="value" id="time-taken">--:--</div>
                    <div class="label">Time Taken</div>
                </div>
                <div class="summary-card">
                    <div class="value" id="sections-completed">0/5</div>
                    <div class="label">Sections Completed</div>
                </div>
                <div class="summary-card">
                    <div class="value" id="ai-interactions">0</div>
                    <div class="label">AI Interactions</div>
                </div>
            </div>

            <div id="section-results"></div>

            <div class="button-group" style="justify-content: center;">
                <button class="btn btn-primary" id="export-pdf-btn">üìÑ Export PDF Report</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION - UPDATE THIS SECTION
        // ============================================
        const CONFIG = {
            // Cloudflare Worker proxy (no local server needed)
            apiEndpoint: 'https://aitest-proxy.kevinkeet.workers.dev',

            // Set to false to use real LLM via the proxy
            useMockResponses: false,

            // Assessment duration in seconds (30 minutes)
            totalTime: 30 * 60
        };

        // ============================================
        // MEDICAL CASES DATA
        // ============================================
        const CASES = [
            // Section 1: Complex Diagnostic Case
            {
                title: "Complex Diagnostic Case",
                taskDescription: "Use the AI assistant to help analyze this case and arrive at the most likely diagnosis. Provide your final diagnosis along with supporting reasoning.",
                content: `
                    <h4>Patient Presentation</h4>
                    <p>A 52-year-old woman presents to the emergency department with a 3-week history of progressive fatigue, intermittent fevers, and a 12-pound unintentional weight loss. She reports night sweats requiring her to change clothes 2-3 times per night.</p>

                    <h4>History of Present Illness</h4>
                    <p>The patient was in her usual state of health until approximately 3 weeks ago when she began experiencing profound fatigue. She initially attributed this to work stress but became concerned when she developed daily fevers (measured up to 101.8¬∞F at home) and drenching night sweats. She also notes early satiety and vague left upper quadrant discomfort after meals.</p>

                    <h4>Past Medical History</h4>
                    <ul>
                        <li>Hypertension (well-controlled on lisinopril)</li>
                        <li>Type 2 diabetes mellitus (HbA1c 7.2% three months ago)</li>
                        <li>Cholecystectomy (2018)</li>
                    </ul>

                    <h4>Social History</h4>
                    <p>Works as an accountant. Never smoker. Social alcohol use (1-2 glasses of wine weekly). No illicit drug use. Lives with husband, no recent travel. No sick contacts.</p>

                    <h4>Vital Signs</h4>
                    <div class="vitals-grid">
                        <div class="vital-item">
                            <div class="vital-label">Temp</div>
                            <div class="vital-value abnormal">101.2¬∞F</div>
                        </div>
                        <div class="vital-item">
                            <div class="vital-label">HR</div>
                            <div class="vital-value abnormal">102 bpm</div>
                        </div>
                        <div class="vital-item">
                            <div class="vital-label">BP</div>
                            <div class="vital-value">128/78</div>
                        </div>
                        <div class="vital-item">
                            <div class="vital-label">RR</div>
                            <div class="vital-value">18</div>
                        </div>
                        <div class="vital-item">
                            <div class="vital-label">SpO2</div>
                            <div class="vital-value">98% RA</div>
                        </div>
                    </div>

                    <h4>Physical Examination</h4>
                    <ul>
                        <li><strong>General:</strong> Fatigued-appearing, diaphoretic</li>
                        <li><strong>HEENT:</strong> Pale conjunctivae, no lymphadenopathy in cervical or supraclavicular regions</li>
                        <li><strong>Cardiovascular:</strong> Tachycardic, regular rhythm, no murmurs</li>
                        <li><strong>Respiratory:</strong> Clear to auscultation bilaterally</li>
                        <li><strong>Abdomen:</strong> Soft, splenomegaly palpable 4 cm below left costal margin, no hepatomegaly, mild LUQ tenderness</li>
                        <li><strong>Skin:</strong> No rashes, petechiae, or ecchymoses</li>
                    </ul>

                    <h4>Laboratory Results</h4>
                    <table class="lab-table">
                        <tr><th>Test</th><th>Result</th><th>Reference</th></tr>
                        <tr><td>WBC</td><td class="abnormal">89,000/ŒºL</td><td>4,500-11,000</td></tr>
                        <tr><td>Hemoglobin</td><td class="abnormal">9.2 g/dL</td><td>12.0-16.0</td></tr>
                        <tr><td>Platelets</td><td class="abnormal">98,000/ŒºL</td><td>150,000-400,000</td></tr>
                        <tr><td>Peripheral smear</td><td colspan="2">Marked leukocytosis with left shift, 15% blasts, occasional Auer rods noted</td></tr>
                        <tr><td>LDH</td><td class="abnormal">892 U/L</td><td>140-280</td></tr>
                        <tr><td>Uric acid</td><td class="abnormal">9.8 mg/dL</td><td>2.5-7.0</td></tr>
                        <tr><td>Creatinine</td><td>1.1 mg/dL</td><td>0.6-1.2</td></tr>
                        <tr><td>AST</td><td class="abnormal">58 U/L</td><td>10-40</td></tr>
                        <tr><td>ALT</td><td class="abnormal">62 U/L</td><td>7-56</td></tr>
                    </table>
                `
            },

            // Section 2: Complex Management Case
            {
                title: "Complex Management Case",
                taskDescription: "Use the AI assistant to help develop a comprehensive treatment plan for this patient. Include specific medications with dosages, monitoring parameters, and follow-up recommendations.",
                content: `
                    <h4>Patient Information</h4>
                    <p>A 68-year-old man with recently diagnosed heart failure with reduced ejection fraction (HFrEF) presents for establishment of care and medication optimization. He was hospitalized 2 weeks ago for acute decompensated heart failure.</p>

                    <h4>Cardiac History</h4>
                    <ul>
                        <li>LVEF 25% on recent echocardiogram</li>
                        <li>NYHA Class III symptoms (dyspnea with minimal exertion)</li>
                        <li>Ischemic cardiomyopathy (s/p PCI to LAD 3 years ago)</li>
                        <li>Paroxysmal atrial fibrillation</li>
                    </ul>

                    <h4>Other Medical History</h4>
                    <ul>
                        <li>Type 2 diabetes mellitus (HbA1c 8.1%)</li>
                        <li>Chronic kidney disease stage 3b (eGFR 38 mL/min/1.73m¬≤)</li>
                        <li>Hypertension</li>
                        <li>Hyperlipidemia</li>
                        <li>GERD</li>
                    </ul>

                    <h4>Current Medications (from discharge)</h4>
                    <div class="medication-list">
                        <div class="medication-item">
                            <span class="med-name">Furosemide</span>
                            <span class="med-dose">40 mg PO BID</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Lisinopril</span>
                            <span class="med-dose">5 mg PO daily</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Metoprolol succinate</span>
                            <span class="med-dose">25 mg PO daily</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Aspirin</span>
                            <span class="med-dose">81 mg PO daily</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Atorvastatin</span>
                            <span class="med-dose">40 mg PO daily</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Metformin</span>
                            <span class="med-dose">500 mg PO BID</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Omeprazole</span>
                            <span class="med-dose">20 mg PO daily</span>
                        </div>
                    </div>

                    <h4>Current Vital Signs</h4>
                    <div class="vitals-grid">
                        <div class="vital-item">
                            <div class="vital-label">BP</div>
                            <div class="vital-value">118/72</div>
                        </div>
                        <div class="vital-item">
                            <div class="vital-label">HR</div>
                            <div class="vital-value">78 bpm</div>
                        </div>
                        <div class="vital-item">
                            <div class="vital-label">Weight</div>
                            <div class="vital-value">92 kg</div>
                        </div>
                        <div class="vital-item">
                            <div class="vital-label">SpO2</div>
                            <div class="vital-value">95% RA</div>
                        </div>
                    </div>

                    <h4>Current Labs</h4>
                    <table class="lab-table">
                        <tr><th>Test</th><th>Result</th><th>Reference</th></tr>
                        <tr><td>Potassium</td><td>4.2 mEq/L</td><td>3.5-5.0</td></tr>
                        <tr><td>Sodium</td><td>138 mEq/L</td><td>136-145</td></tr>
                        <tr><td>Creatinine</td><td class="abnormal">1.9 mg/dL</td><td>0.7-1.3</td></tr>
                        <tr><td>eGFR</td><td class="abnormal">38 mL/min</td><td>>60</td></tr>
                        <tr><td>BNP</td><td class="abnormal">850 pg/mL</td><td><100</td></tr>
                        <tr><td>HbA1c</td><td class="abnormal">8.1%</td><td><7.0%</td></tr>
                    </table>

                    <h4>Clinical Question</h4>
                    <p>How would you optimize this patient's guideline-directed medical therapy (GDMT) for HFrEF while considering his comorbidities? Include specific medications, target doses, titration strategy, and monitoring plan.</p>
                `
            },

            // Section 3: Error Detection Case
            {
                title: "Error Detection Case",
                taskDescription: "Review this patient's medication list and clinical information. Use the AI assistant to help identify ALL medication errors, drug interactions, contraindications, or safety concerns. List each issue found with an explanation.",
                content: `
                    <h4>Patient Information</h4>
                    <p>A 74-year-old woman presents for routine follow-up. She has multiple chronic conditions and takes numerous medications. Review her current medication list for potential errors, interactions, or safety concerns.</p>

                    <h4>Medical History</h4>
                    <ul>
                        <li>Atrial fibrillation (on anticoagulation)</li>
                        <li>Hypertension</li>
                        <li>Osteoporosis with recent vertebral compression fracture</li>
                        <li>Chronic kidney disease stage 4 (eGFR 22 mL/min/1.73m¬≤)</li>
                        <li>Type 2 diabetes mellitus</li>
                        <li>Gout</li>
                        <li>Chronic pain syndrome</li>
                        <li>Anxiety</li>
                        <li>History of GI bleeding (peptic ulcer, 2022)</li>
                    </ul>

                    <h4>Allergies</h4>
                    <p><strong>Sulfa drugs</strong> - rash</p>

                    <h4>Current Medications</h4>
                    <div class="medication-list">
                        <div class="medication-item">
                            <span class="med-name">Warfarin</span>
                            <span class="med-dose">5 mg PO daily (INR goal 2-3)</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Aspirin</span>
                            <span class="med-dose">325 mg PO daily</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Lisinopril</span>
                            <span class="med-dose">20 mg PO daily</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Metformin</span>
                            <span class="med-dose">1000 mg PO BID</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Alendronate</span>
                            <span class="med-dose">70 mg PO weekly</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Ibuprofen</span>
                            <span class="med-dose">600 mg PO TID PRN pain</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Hydrochlorothiazide</span>
                            <span class="med-dose">25 mg PO daily</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Alprazolam</span>
                            <span class="med-dose">0.5 mg PO TID</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Zolpidem</span>
                            <span class="med-dose">10 mg PO QHS</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Allopurinol</span>
                            <span class="med-dose">300 mg PO daily</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Vitamin D3</span>
                            <span class="med-dose">2000 IU PO daily</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Calcium carbonate</span>
                            <span class="med-dose">600 mg PO BID</span>
                        </div>
                    </div>

                    <h4>Recent Labs</h4>
                    <table class="lab-table">
                        <tr><th>Test</th><th>Result</th><th>Reference</th></tr>
                        <tr><td>INR</td><td>2.4</td><td>2.0-3.0</td></tr>
                        <tr><td>Creatinine</td><td class="abnormal">2.8 mg/dL</td><td>0.6-1.2</td></tr>
                        <tr><td>eGFR</td><td class="abnormal">22 mL/min</td><td>>60</td></tr>
                        <tr><td>Potassium</td><td>4.8 mEq/L</td><td>3.5-5.0</td></tr>
                        <tr><td>HbA1c</td><td>7.4%</td><td><7.0%</td></tr>
                        <tr><td>Hemoglobin</td><td class="abnormal">10.2 g/dL</td><td>12.0-16.0</td></tr>
                    </table>

                    <h4>Your Task</h4>
                    <p>Identify ALL medication-related problems including: drug-drug interactions, drug-disease contraindications, inappropriate dosing for renal function, duplicate therapies, high-risk medications in elderly, and any other safety concerns.</p>
                `
            },

            // Section 4: Summarization Task
            {
                title: "Clinical Summarization",
                taskDescription: "Use the AI assistant to help summarize this complex case presentation into a concise one-paragraph handoff summary suitable for communicating to an oncoming physician.",
                content: `
                    <h4>Admission Note - Complex Case for Summarization</h4>

                    <p><strong>Chief Complaint:</strong> Altered mental status and fever</p>

                    <p><strong>History of Present Illness:</strong>
                    Mr. James Thompson is a 71-year-old male with a past medical history significant for type 2 diabetes mellitus complicated by peripheral neuropathy and nephropathy (baseline creatinine 1.8), atrial fibrillation on apixaban, hypertension, hyperlipidemia, and recent right total knee arthroplasty (3 weeks ago) who presents from his rehabilitation facility with altered mental status and fever. Per the rehab nursing staff, the patient was noted to be increasingly confused over the past 48 hours, initially thought to be sundowning, but this morning he was found to be febrile to 102.8¬∞F and was not oriented to place or time. His baseline mental status is alert and oriented x3.</p>

                    <p>The patient's daughter reports that he complained of right knee pain and swelling two days ago, which was attributed to post-operative healing. She also notes he has had decreased oral intake and appeared more fatigued. She denies any witnessed falls, head trauma, cough, shortness of breath, chest pain, abdominal pain, diarrhea, or urinary symptoms, though she notes he has had a Foley catheter since surgery. No recent sick contacts. No known COVID-19 exposure.</p>

                    <p><strong>Past Medical History:</strong> Type 2 diabetes mellitus with peripheral neuropathy and nephropathy, atrial fibrillation (CHA2DS2-VASc 4), hypertension, hyperlipidemia, benign prostatic hyperplasia, osteoarthritis, chronic kidney disease stage 3, depression</p>

                    <p><strong>Past Surgical History:</strong> Right total knee arthroplasty (3 weeks ago), appendectomy (1985), cataract surgery bilateral</p>

                    <p><strong>Home Medications:</strong> Apixaban 5mg BID, metformin 500mg BID, lisinopril 10mg daily, amlodipine 5mg daily, atorvastatin 40mg daily, gabapentin 300mg TID, tamsulosin 0.4mg daily, sertraline 50mg daily, acetaminophen 650mg Q6H PRN pain</p>

                    <p><strong>Allergies:</strong> Penicillin (hives)</p>

                    <p><strong>Social History:</strong> Retired engineer. Former smoker (quit 20 years ago, 30 pack-year history). Occasional alcohol use (1-2 beers/week, none since surgery). Lives with wife who is his primary caregiver. Has been in rehabilitation facility since knee surgery.</p>

                    <p><strong>Family History:</strong> Father died of MI at 68, mother with Alzheimer's dementia, sister with breast cancer</p>

                    <p><strong>Physical Examination:</strong></p>
                    <ul>
                        <li>Vitals: T 102.4¬∞F, HR 112, BP 98/62, RR 22, SpO2 94% on 2L NC</li>
                        <li>General: Elderly male, appears acutely ill, intermittently agitated, diaphoretic</li>
                        <li>HEENT: Dry mucous membranes, pupils equal and reactive</li>
                        <li>Neck: Supple, no meningismus, no JVD</li>
                        <li>Cardiac: Tachycardic, irregularly irregular, no murmurs appreciated</li>
                        <li>Lungs: Clear to auscultation bilaterally, no wheezes/crackles</li>
                        <li>Abdomen: Soft, non-tender, non-distended, normal bowel sounds</li>
                        <li>Right Knee: Surgical incision with surrounding erythema (8cm x 6cm), warmth, moderate effusion, tenderness to palpation, limited ROM due to pain. No purulent drainage at incision site.</li>
                        <li>Extremities: 1+ pitting edema bilateral lower extremities, Foley catheter in place with cloudy urine</li>
                        <li>Neurologic: Alert but oriented only to self, follows simple commands inconsistently, no focal deficits, moving all extremities</li>
                    </ul>

                    <p><strong>Laboratory Results:</strong></p>
                    <ul>
                        <li>WBC 18,400 (88% neutrophils, 6% bands)</li>
                        <li>Hemoglobin 10.8, Platelets 342,000</li>
                        <li>BMP: Na 134, K 4.9, Cl 98, CO2 18, BUN 48, Creatinine 2.9 (baseline 1.8), Glucose 287</li>
                        <li>Lactate 3.2 mmol/L</li>
                        <li>Procalcitonin 8.4 ng/mL</li>
                        <li>Urinalysis: Large leukocyte esterase, positive nitrites, >100 WBC, many bacteria</li>
                        <li>Blood cultures: Pending (2 sets drawn)</li>
                        <li>Right knee arthrocentesis: Turbid fluid, WBC 52,000 (92% PMNs), no crystals, gram stain shows gram-positive cocci in clusters, culture pending</li>
                    </ul>

                    <p><strong>Imaging:</strong></p>
                    <ul>
                        <li>Chest X-ray: No acute cardiopulmonary process</li>
                        <li>Right knee X-ray: Post-surgical changes, moderate joint effusion, no hardware loosening</li>
                        <li>CT Head without contrast: Age-appropriate atrophy, no acute intracranial abnormality</li>
                    </ul>

                    <p><strong>Assessment and Plan:</strong>
                    71-year-old male with DM, CKD, recent TKA presenting with sepsis likely secondary to prosthetic joint infection and concurrent UTI. Also with acute kidney injury and delirium. Patient meets sepsis criteria. Orthopedics emergently consulted for likely surgical washout. Patient started on vancomycin and cefepime (renally dosed) given penicillin allergy. Foley removed after obtaining culture. IV fluid resuscitation initiated with close monitoring of volume status given cardiac history. Apixaban held. Blood glucose management with sliding scale insulin. Goals of care discussion with family pending - patient is full code per rehab records.</p>
                `
            },

            // Section 5: Patient-Friendly Discharge Instructions
            {
                title: "Patient Communication",
                taskDescription: "Use the AI assistant to help convert this discharge summary into clear, patient-friendly discharge instructions that a patient with limited health literacy could understand.",
                content: `
                    <h4>Discharge Summary</h4>

                    <p><strong>Patient:</strong> Maria Santos, 58-year-old female</p>
                    <p><strong>Admission Date:</strong> January 20, 2026</p>
                    <p><strong>Discharge Date:</strong> January 25, 2026</p>

                    <p><strong>Principal Diagnosis:</strong> ST-elevation myocardial infarction (STEMI), anterior wall</p>

                    <p><strong>Secondary Diagnoses:</strong></p>
                    <ul>
                        <li>Type 2 diabetes mellitus</li>
                        <li>Hypertension</li>
                        <li>Hyperlipidemia</li>
                        <li>Newly diagnosed heart failure with reduced ejection fraction (LVEF 35%)</li>
                    </ul>

                    <p><strong>Hospital Course:</strong>
                    Patient presented with acute onset substernal chest pain and diaphoresis. ECG showed ST elevations in V1-V4. Emergent cardiac catheterization revealed 100% occlusion of the proximal LAD. Successful PCI performed with drug-eluting stent placement. Post-procedure course complicated by transient cardiogenic shock requiring brief inotropic support. Echocardiogram showed anterior wall hypokinesis with LVEF 35%. Patient stabilized on guideline-directed medical therapy. Participated in cardiac rehabilitation education. Tobacco cessation counseling provided.</p>

                    <p><strong>Discharge Medications:</strong></p>
                    <div class="medication-list">
                        <div class="medication-item">
                            <span class="med-name">Aspirin</span>
                            <span class="med-dose">81 mg PO daily - LIFELONG</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Ticagrelor (Brilinta)</span>
                            <span class="med-dose">90 mg PO BID - for 12 months (DO NOT STOP without talking to cardiologist)</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Metoprolol succinate</span>
                            <span class="med-dose">50 mg PO daily</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Lisinopril</span>
                            <span class="med-dose">10 mg PO daily</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Atorvastatin</span>
                            <span class="med-dose">80 mg PO at bedtime</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Eplerenone</span>
                            <span class="med-dose">25 mg PO daily</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Empagliflozin</span>
                            <span class="med-dose">10 mg PO daily</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Metformin</span>
                            <span class="med-dose">500 mg PO BID (continue home dose)</span>
                        </div>
                        <div class="medication-item">
                            <span class="med-name">Nitroglycerin SL</span>
                            <span class="med-dose">0.4 mg PRN chest pain (max 3 doses, call 911 if no relief)</span>
                        </div>
                    </div>

                    <p><strong>Allergies:</strong> NKDA</p>

                    <p><strong>Activity Restrictions:</strong></p>
                    <ul>
                        <li>No driving for 1 week</li>
                        <li>No lifting >10 lbs for 2 weeks</li>
                        <li>Cardiac rehabilitation enrollment scheduled</li>
                        <li>Gradually increase activity as tolerated</li>
                    </ul>

                    <p><strong>Diet:</strong> Heart-healthy, low sodium (<2g/day), diabetic diet</p>

                    <p><strong>Follow-up Appointments:</strong></p>
                    <ul>
                        <li>Cardiology: Dr. Chen, February 1, 2026 at 2:00 PM</li>
                        <li>Primary Care: Dr. Williams, February 8, 2026 at 10:00 AM</li>
                        <li>Cardiac Rehabilitation: Starts February 3, 2026</li>
                    </ul>

                    <p><strong>Warning Signs - Seek immediate medical attention if:</strong></p>
                    <ul>
                        <li>Chest pain not relieved by nitroglycerin</li>
                        <li>Shortness of breath at rest or worsening with activity</li>
                        <li>Rapid weight gain (>3 lbs in 1 day or >5 lbs in 1 week)</li>
                        <li>Swelling in legs/ankles</li>
                        <li>Dizziness or fainting</li>
                        <li>Unusual bleeding or bruising</li>
                    </ul>

                    <p><strong>Your Task:</strong> Create patient-friendly discharge instructions that explain: what happened during hospitalization, all medications (what they're for, how to take them), warning signs in plain language, and follow-up care. Use language appropriate for someone with limited health literacy (aim for 6th grade reading level). Avoid medical jargon.</p>
                `
            }
        ];

        // Mock AI responses for demo mode
        const MOCK_RESPONSES = {
            diagnostic: `Based on the clinical presentation and laboratory findings, this case strongly suggests **Acute Myeloid Leukemia (AML)**.

Key diagnostic features:
1. **Constitutional symptoms**: B-symptoms (fever, night sweats, weight loss) over 3 weeks
2. **Marked leukocytosis**: WBC 89,000/ŒºL with left shift
3. **Peripheral smear**: 15% blasts with **Auer rods** (pathognomonic for AML)
4. **Cytopenias**: Anemia (Hgb 9.2) and thrombocytopenia (platelets 98K)
5. **Splenomegaly**: Consistent with extramedullary hematopoiesis
6. **Elevated LDH and uric acid**: Reflecting high cell turnover

The presence of Auer rods on peripheral smear is essentially diagnostic of AML and distinguishes this from other causes of leukocytosis.

**Recommended next steps:**
- Urgent hematology/oncology consultation
- Bone marrow biopsy with cytogenetics and molecular studies
- Tumor lysis syndrome prophylaxis (hydration, allopurinol)
- Flow cytometry for immunophenotyping`,

            management: `For this patient with HFrEF (LVEF 25%), here's an evidence-based GDMT optimization plan:

**Current gaps in GDMT:**
- No ARNI (should replace ACEi)
- No SGLT2 inhibitor
- No MRA
- Beta-blocker and ACEi at sub-target doses

**Recommended changes:**

1. **Switch Lisinopril ‚Üí Sacubitril/Valsartan (Entresto)**
   - Start: 24/26 mg BID (reduced dose for renal function)
   - Wait 36 hours after stopping lisinopril
   - Target: 97/103 mg BID

2. **Add Empagliflozin (Jardiance) 10 mg daily**
   - Safe with eGFR 38
   - Also benefits diabetes control
   - Monitor for hypotension

3. **Add Spironolactone 12.5 mg daily**
   - Monitor K+ and creatinine in 1 week
   - Target: 25-50 mg daily if tolerated

4. **Uptitrate Metoprolol succinate**
   - Current: 25 mg ‚Üí Target: 200 mg daily
   - Increase every 2 weeks as tolerated

**Monitoring plan:**
- BMP in 1-2 weeks after each change
- Watch for hyperkalemia, AKI, hypotension
- Consider reducing/stopping metformin if eGFR declines

**Note**: Given CKD Stage 3b, dose adjustments and close monitoring are essential.`,

            errors: `I've identified **9 significant medication safety concerns**:

**1. CRITICAL - NSAID + Anticoagulation + GI Bleeding History**
Ibuprofen 600mg TID with warfarin dramatically increases GI bleeding risk, especially with prior peptic ulcer. **Discontinue ibuprofen immediately.**

**2. CRITICAL - Metformin contraindicated (eGFR 22)**
Metformin should be stopped when eGFR <30 due to lactic acidosis risk. **Discontinue metformin.**

**3. HIGH RISK - Dual antiplatelet + anticoagulant**
Aspirin 325mg + warfarin without clear indication (no recent ACS/stent). If AFib alone, aspirin adds bleeding risk without benefit. **Reassess need for aspirin or reduce to 81mg if indicated.**

**4. RENAL DOSING - Allopurinol dose too high**
With eGFR 22, allopurinol should be reduced to 100mg daily to prevent toxicity.

**5. SULFA ALLERGY - Hydrochlorothiazide**
HCTZ is a sulfonamide diuretic - potential cross-reactivity with documented sulfa allergy. Consider alternative.

**6. FALL RISK - Dual sedatives in elderly**
Alprazolam + zolpidem (Beers Criteria): High fall/fracture risk, cognitive impairment. **Taper and discontinue both.**

**7. DRUG INTERACTION - Calcium + Alendronate**
Calcium decreases alendronate absorption. Must be separated by at least 30 minutes (ideally 2 hours).

**8. RENAL - Alendronate relatively contraindicated**
Not recommended with eGFR <35. Consider IV zoledronic acid or denosumab instead.

**9. NSAID + CKD + ACEi**
"Triple whammy" - Ibuprofen + Lisinopril + diuretic with CKD causes additive nephrotoxicity.`,

            summarization: `**Handoff Summary:**

Mr. Thompson is a 71-year-old male with DM, CKD (baseline Cr 1.8), AFib on apixaban, and recent right TKA (3 weeks ago) admitted with sepsis. He has **two infectious sources**: a **septic prosthetic joint** (knee aspirate 52K WBCs, gram-positive cocci in clusters) and a **complicated UTI** (Foley-associated). He presented with fever to 102.8¬∞F, altered mental status, hypotension (98/62), tachycardia, and lactate 3.2. He has developed AKI (Cr 2.9 from 1.8) and delirium. Currently on vancomycin and cefepime (renally dosed) given penicillin allergy. Orthopedics consulted for emergent surgical washout of the knee - this is the priority intervention. Anticoagulation held. Blood cultures and knee cultures pending. Goals of care discussion with family is pending; currently full code. Key overnight concerns: hemodynamic stability post-operatively, renal function trending, and mental status improvement with infection source control.`,

            patient: `# Going Home After Your Heart Attack

## What Happened
You had a heart attack. This means a blood vessel to your heart got blocked. The doctors put in a small tube called a stent to open it back up. Your heart muscle was damaged, so it's not pumping as strongly as before. With your medications and lifestyle changes, it can get better.

## Your Medications - Very Important!

**Blood Thinners (NEVER stop without asking your doctor):**
‚Ä¢ **Aspirin** - Take 1 small pill every morning. This keeps your stent open. Take forever.
‚Ä¢ **Ticagrelor (Brilinta)** - Take 1 pill in the morning AND 1 pill at night. VERY IMPORTANT for your stent. Take for 1 year.

**Heart Medications:**
‚Ä¢ **Metoprolol** - Slows your heart to help it heal. Take 1 pill every morning.
‚Ä¢ **Lisinopril** - Protects your heart. Take 1 pill every morning. May make you cough - that's OK.
‚Ä¢ **Atorvastatin** - Lowers cholesterol. Take 1 pill at bedtime.
‚Ä¢ **Eplerenone** - Helps your heart pump better. Take 1 pill every morning.

**Diabetes Medications:**
‚Ä¢ **Empagliflozin** - NEW pill that helps your heart AND blood sugar. Take every morning.
‚Ä¢ **Metformin** - Continue as before for diabetes.

**Emergency Medication:**
‚Ä¢ **Nitroglycerin tablets** - For chest pain only. Put under your tongue. If pain doesn't go away after 1 pill, call 911.

## Warning Signs - Call 911 Right Away If:
‚ùå Chest pain that won't go away
‚ùå Can't catch your breath
‚ùå Feel like you might faint

## Call Your Doctor If:
‚ö†Ô∏è Feet or ankles swell up
‚ö†Ô∏è Gain more than 3 pounds in one day
‚ö†Ô∏è Unusual bruising or bleeding
‚ö†Ô∏è Feel very tired or weak

## Your Appointments
üìÖ Heart Doctor (Dr. Chen): February 1 at 2:00 PM
üìÖ Regular Doctor (Dr. Williams): February 8 at 10:00 AM
üìÖ Heart Exercise Program: Starts February 3

## Activity
‚úì Rest for the first week
‚úì No driving for 1 week
‚úì Don't lift anything heavy (like groceries) for 2 weeks
‚úì Walking is good - start slow

## Diet
‚Ä¢ Less salt (no adding salt, avoid chips/fast food)
‚Ä¢ Fruits, vegetables, whole grains
‚Ä¢ Watch your portions for diabetes`
        };

        // ============================================
        // APPLICATION STATE
        // ============================================
        let state = {
            participant: null,
            currentSection: 0,
            responses: [{}, {}, {}, {}, {}], // Each section: {response: '', chatHistory: []}
            startTime: null,
            endTime: null,
            timeRemaining: CONFIG.totalTime,
            timerInterval: null,
            totalAiInteractions: 0
        };

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const elements = {
            registrationPage: document.getElementById('registration-page'),
            assessmentPage: document.getElementById('assessment-page'),
            resultsPage: document.getElementById('results-page'),
            registrationForm: document.getElementById('registration-form'),
            timer: document.getElementById('timer'),
            progressFill: document.getElementById('progress-fill'),
            sectionNav: document.getElementById('section-nav'),
            caseContent: document.getElementById('case-content'),
            taskInstructions: document.getElementById('task-instructions'),
            chatMessages: document.getElementById('chat-messages'),
            chatInput: document.getElementById('chat-input'),
            sendBtn: document.getElementById('send-btn'),
            userResponse: document.getElementById('user-response'),
            prevBtn: document.getElementById('prev-btn'),
            saveBtn: document.getElementById('save-btn'),
            finishBtn: document.getElementById('finish-btn'),
            exportPdfBtn: document.getElementById('export-pdf-btn')
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        function init() {
            elements.registrationForm.addEventListener('submit', handleRegistration);
            elements.sendBtn.addEventListener('click', handleSendMessage);
            elements.chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });
            elements.prevBtn.addEventListener('click', handlePrevious);
            elements.saveBtn.addEventListener('click', handleSaveAndContinue);
            elements.finishBtn.addEventListener('click', handleFinish);
            elements.exportPdfBtn.addEventListener('click', exportToPDF);

            // Section navigation
            document.querySelectorAll('.section-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const section = parseInt(btn.dataset.section);
                    navigateToSection(section);
                });
            });
        }

        // ============================================
        // REGISTRATION
        // ============================================
        function handleRegistration(e) {
            e.preventDefault();
            state.participant = {
                name: document.getElementById('participant-name').value,
                email: document.getElementById('participant-email').value,
                role: document.getElementById('participant-role').value,
                specialty: document.getElementById('participant-specialty').value,
                date: new Date().toISOString()
            };

            startAssessment();
        }

        function startAssessment() {
            elements.registrationPage.classList.add('hidden');
            elements.assessmentPage.classList.remove('hidden');

            state.startTime = new Date();
            startTimer();
            loadSection(0);
        }

        // ============================================
        // TIMER
        // ============================================
        function startTimer() {
            updateTimerDisplay();
            state.timerInterval = setInterval(() => {
                state.timeRemaining--;
                updateTimerDisplay();

                if (state.timeRemaining <= 0) {
                    clearInterval(state.timerInterval);
                    handleFinish();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(state.timeRemaining / 60);
            const seconds = state.timeRemaining % 60;
            elements.timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            // Update timer color based on time remaining
            elements.timer.classList.remove('warning', 'danger');
            if (state.timeRemaining <= 300) { // 5 minutes
                elements.timer.classList.add('danger');
            } else if (state.timeRemaining <= 600) { // 10 minutes
                elements.timer.classList.add('warning');
            }
        }

        // ============================================
        // SECTION NAVIGATION
        // ============================================
        function loadSection(index) {
            const caseData = CASES[index];
            state.currentSection = index;

            // Update case content
            elements.caseContent.innerHTML = caseData.content;

            // Update task instructions
            elements.taskInstructions.innerHTML = `
                <h4>üìù Task ${index + 1} of 5: ${caseData.title}</h4>
                <p>${caseData.taskDescription}</p>
            `;

            // Load saved response if exists
            elements.userResponse.value = state.responses[index].response || '';

            // Load chat history
            loadChatHistory(index);

            // Update navigation buttons
            elements.prevBtn.style.visibility = index === 0 ? 'hidden' : 'visible';
            elements.saveBtn.textContent = index === 4 ? 'Save Response' : 'Save & Continue ‚Üí';
            elements.finishBtn.classList.toggle('hidden', index !== 4);

            // Update section nav styling
            updateSectionNav();

            // Update progress bar
            updateProgress();
        }

        function loadChatHistory(index) {
            elements.chatMessages.innerHTML = `
                <div class="message system">
                    Use the AI assistant to help with this task. Your interaction will be recorded for review.
                </div>
            `;

            const history = state.responses[index].chatHistory || [];
            history.forEach(msg => {
                addMessageToChat(msg.role, msg.content, false);
            });
        }

        function updateSectionNav() {
            document.querySelectorAll('.section-btn').forEach((btn, index) => {
                btn.classList.remove('active', 'completed');
                if (index === state.currentSection) {
                    btn.classList.add('active');
                } else if (state.responses[index].response) {
                    btn.classList.add('completed');
                }
            });
        }

        function updateProgress() {
            const completed = state.responses.filter(r => r.response).length;
            const progress = (completed / 5) * 100;
            elements.progressFill.style.width = `${progress}%`;
        }

        function navigateToSection(index) {
            // Save current response before navigating
            saveCurrentResponse();
            loadSection(index);
        }

        function handlePrevious() {
            if (state.currentSection > 0) {
                saveCurrentResponse();
                loadSection(state.currentSection - 1);
            }
        }

        function handleSaveAndContinue() {
            saveCurrentResponse();
            if (state.currentSection < 4) {
                loadSection(state.currentSection + 1);
            }
        }

        function saveCurrentResponse() {
            state.responses[state.currentSection].response = elements.userResponse.value;
        }

        // ============================================
        // CHAT FUNCTIONALITY
        // ============================================
        async function handleSendMessage() {
            const message = elements.chatInput.value.trim();
            if (!message) return;

            // Clear input and disable button
            elements.chatInput.value = '';
            elements.sendBtn.disabled = true;

            // Add user message to chat
            addMessageToChat('user', message);
            saveChatMessage('user', message);

            // Show loading indicator
            const loadingId = addLoadingIndicator();

            try {
                const response = await getAIResponse(message);
                removeLoadingIndicator(loadingId);
                addMessageToChat('assistant', response);
                saveChatMessage('assistant', response);
                state.totalAiInteractions++;
            } catch (error) {
                removeLoadingIndicator(loadingId);
                addMessageToChat('system', 'Error getting AI response. Please try again.');
                console.error('AI Error:', error);
            }

            elements.sendBtn.disabled = false;
            elements.chatInput.focus();
        }

        function addMessageToChat(role, content, scroll = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = formatMessage(content);
            elements.chatMessages.appendChild(messageDiv);

            if (scroll) {
                elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            }
        }

        function formatMessage(content) {
            // Basic markdown-like formatting
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
        }

        function saveChatMessage(role, content) {
            if (!state.responses[state.currentSection].chatHistory) {
                state.responses[state.currentSection].chatHistory = [];
            }
            state.responses[state.currentSection].chatHistory.push({ role, content });
        }

        function addLoadingIndicator() {
            const id = 'loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.id = id;
            loadingDiv.className = 'message assistant';
            loadingDiv.innerHTML = '<span class="loading"></span> Thinking...';
            elements.chatMessages.appendChild(loadingDiv);
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            return id;
        }

        function removeLoadingIndicator(id) {
            const element = document.getElementById(id);
            if (element) element.remove();
        }

        async function getAIResponse(message) {
            // If real API is configured, use it
            if (CONFIG.apiEndpoint && !CONFIG.useMockResponses) {
                return await callRealAPI(message);
            }

            // Otherwise, use mock responses
            return getMockResponse(message);
        }

        async function callRealAPI(message) {
            const sectionContext = CASES[state.currentSection];
            const chatHistory = state.responses[state.currentSection].chatHistory || [];

            const response = await fetch(CONFIG.apiEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    messages: [
                        {
                            role: 'system',
                            content: `You are a medical AI assistant helping a healthcare professional with a clinical task.

Current task: ${sectionContext.title}
Task description: ${sectionContext.taskDescription}

Provide helpful, accurate medical information. Be concise but thorough. If you're unsure about something, say so.`
                        },
                        ...chatHistory.map(msg => ({
                            role: msg.role,
                            content: msg.content
                        })),
                        {
                            role: 'user',
                            content: message
                        }
                    ]
                })
            });

            if (!response.ok) {
                throw new Error('API request failed');
            }

            const data = await response.json();
            return data.content || data.message || data.choices?.[0]?.message?.content;
        }

        function getMockResponse(message) {
            // Simulate API delay
            return new Promise((resolve) => {
                setTimeout(() => {
                    const section = state.currentSection;
                    const responses = [
                        MOCK_RESPONSES.diagnostic,
                        MOCK_RESPONSES.management,
                        MOCK_RESPONSES.errors,
                        MOCK_RESPONSES.summarization,
                        MOCK_RESPONSES.patient
                    ];

                    // For demo, return the prepared response if it's the first message
                    // Otherwise return a generic helpful response
                    const chatHistory = state.responses[section].chatHistory || [];
                    if (chatHistory.length <= 1) {
                        resolve(responses[section]);
                    } else {
                        resolve(`Based on your question about "${message.substring(0, 50)}...", I can provide additional clarification.

The key points to consider are:
1. Review the clinical data carefully
2. Consider the patient's specific context
3. Apply evidence-based guidelines
4. Document your reasoning clearly

Is there a specific aspect you'd like me to elaborate on?`);
                    }
                }, 1000 + Math.random() * 1000);
            });
        }

        // ============================================
        // FINISH AND RESULTS
        // ============================================
        function handleFinish() {
            saveCurrentResponse();
            clearInterval(state.timerInterval);
            state.endTime = new Date();

            showResults();
        }

        function showResults() {
            elements.assessmentPage.classList.add('hidden');
            elements.resultsPage.classList.remove('hidden');

            // Participant info
            document.getElementById('results-participant-info').textContent =
                `${state.participant.name} | ${state.participant.role} - ${state.participant.specialty} | ${new Date().toLocaleDateString()}`;

            // Time taken
            const timeTaken = CONFIG.totalTime - state.timeRemaining;
            const minutes = Math.floor(timeTaken / 60);
            const seconds = timeTaken % 60;
            document.getElementById('time-taken').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            // Sections completed
            const completed = state.responses.filter(r => r.response).length;
            document.getElementById('sections-completed').textContent = `${completed}/5`;

            // AI interactions
            document.getElementById('ai-interactions').textContent = state.totalAiInteractions;

            // Section details
            const resultsContainer = document.getElementById('section-results');
            resultsContainer.innerHTML = '';

            CASES.forEach((caseData, index) => {
                const response = state.responses[index];
                const chatCount = (response.chatHistory || []).filter(m => m.role === 'user').length;

                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'section-result';
                sectionDiv.innerHTML = `
                    <h4>
                        ${response.response ? '‚úÖ' : '‚ö†Ô∏è'} Section ${index + 1}: ${caseData.title}
                        <span style="font-weight: normal; color: var(--gray-600); font-size: 0.85rem; margin-left: auto;">
                            (${chatCount} AI queries)
                        </span>
                    </h4>
                    <div class="response-display">${response.response || 'No response provided'}</div>
                `;
                resultsContainer.appendChild(sectionDiv);
            });
        }

        // ============================================
        // PDF EXPORT
        // ============================================
        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 20;
            const contentWidth = pageWidth - 2 * margin;
            let y = margin;

            // Title
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('Medical AI Competency Assessment Report', margin, y);
            y += 12;

            // Participant info
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Participant: ${state.participant.name}`, margin, y);
            y += 5;
            doc.text(`Email: ${state.participant.email}`, margin, y);
            y += 5;
            doc.text(`Role: ${state.participant.role} - ${state.participant.specialty}`, margin, y);
            y += 5;
            doc.text(`Date: ${new Date(state.participant.date).toLocaleString()}`, margin, y);
            y += 10;

            // Summary
            const timeTaken = CONFIG.totalTime - state.timeRemaining;
            const minutes = Math.floor(timeTaken / 60);
            const seconds = timeTaken % 60;
            const completed = state.responses.filter(r => r.response).length;

            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Assessment Summary', margin, y);
            y += 7;

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Time Taken: ${minutes}:${seconds.toString().padStart(2, '0')}`, margin, y);
            y += 5;
            doc.text(`Sections Completed: ${completed}/5`, margin, y);
            y += 5;
            doc.text(`Total AI Interactions: ${state.totalAiInteractions}`, margin, y);
            y += 12;

            // Each section
            CASES.forEach((caseData, index) => {
                // Check if we need a new page
                if (y > 250) {
                    doc.addPage();
                    y = margin;
                }

                const response = state.responses[index];
                const chatHistory = response.chatHistory || [];

                // Section header
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`Section ${index + 1}: ${caseData.title}`, margin, y);
                y += 7;

                // Response
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('Participant Response:', margin, y);
                y += 5;

                doc.setFont(undefined, 'normal');
                const responseText = response.response || 'No response provided';
                const splitResponse = doc.splitTextToSize(responseText, contentWidth);

                splitResponse.forEach(line => {
                    if (y > 280) {
                        doc.addPage();
                        y = margin;
                    }
                    doc.text(line, margin, y);
                    y += 5;
                });
                y += 5;

                // AI Chat Log
                if (chatHistory.length > 0) {
                    doc.setFont(undefined, 'bold');
                    doc.text('AI Interaction Log:', margin, y);
                    y += 5;

                    doc.setFont(undefined, 'normal');
                    chatHistory.forEach(msg => {
                        if (y > 280) {
                            doc.addPage();
                            y = margin;
                        }

                        const prefix = msg.role === 'user' ? 'User: ' : 'AI: ';
                        const text = prefix + msg.content.substring(0, 200) + (msg.content.length > 200 ? '...' : '');
                        const splitText = doc.splitTextToSize(text, contentWidth);

                        splitText.forEach(line => {
                            if (y > 280) {
                                doc.addPage();
                                y = margin;
                            }
                            doc.text(line, margin, y);
                            y += 4;
                        });
                        y += 2;
                    });
                }

                y += 10;
            });

            // Footer on each page
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128);
                doc.text(
                    `Page ${i} of ${pageCount} | Generated: ${new Date().toLocaleString()}`,
                    pageWidth / 2,
                    doc.internal.pageSize.getHeight() - 10,
                    { align: 'center' }
                );
                doc.setTextColor(0);
            }

            // Save the PDF
            const filename = `AI_Competency_Assessment_${state.participant.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(filename);
        }

        // Initialize the application
        init();
    </script>
</body>
</html>
